<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="styles.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap"
      rel="stylesheets"
    />
    <script src="scripts/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dom-to-image@2.6.0/dist/dom-to-image.min.js"></script>

    <title>Restrospectiva Mobapps 2024</title>
    <style>
      :root {
        --primary-color: #0073f4;
      }
    </style>
  </head>
  <body>
    <div class="main-content">
      <div class="header-content">
        <img src="./assets/index/logo.png" alt="logo" />
      </div>
      <div class="resume-content">
        <div class="resume-title-content">
          <div class="resume-title">
            <h1>
              Seu ano em retrospectiva: <br />
              <span>RETROVISOR 2024</span>
            </h1>
            <p>
              Olá <strong id="username-display">[username]</strong>! Estamos
              empolgados em apresentar sua retrospectiva do ano. Vamos explorar
              juntos os destaques da sua jornada em 2024!
            </p>
          </div>
          <div class="resume-img">
            <img
              src="./assets/index/illustration-man-using-gesture-control-car-modern-technology-innovation-concept 1.png"
              alt="illustration-man-using-gesture-control-car-modern-technology"
            />
          </div>
        </div>
      </div>
      <div class="rides-content">
        <h1>
          Você fez um total de
          <span id="total-rides">[totalRides]</span> <span>viagens</span> em
          2024!
        </h1>
        <div class="rides-info-content">
          <div class="rides-info-card-content">
            <img src="./assets/index/carro.svg" alt="" />
            <h2>
              Você percorreu
              <span
                >impressionantes <span id="total-km">[totalKm]</span> km</span
              >
              ao longo do ano.
            </h2>
            <p>Agradecemos sua confiança de está conosco nessa jornada!</p>
          </div>
          <div class="rides-info-card-content">
            <img src="./assets/index/digital-payment.png" alt="" />
            <h2>
              Seu método de pagamento favorito é o
              <span id="payment-method">[paymentMethod]</span>.
            </h2>
            <p>Você é um verdadeiro farol, sempre pronto para a aventura!</p>
          </div>
          <div class="rides-info-card-content">
            <img src="./assets/index/localizador-de-mapa.png" alt="" />
            <h2>
              O seu <span>primeiro destino em 2024</span> junto a nossa
              plataforma foi:
            </h2>
            <p id="first-destination">[firstDestination]</p>
          </div>
        </div>
      </div>
      <div class="days-content">
        <div class="days-title-content">
          <h1>
            <strong id="username-display2">[username]</strong> você sabe quantos
            dias você esteve presente com a Mobapps? Descubra agora:
            <br />
            <br />
            <span id="total-days">[totalDays]</span> <span>dias</span>
          </h1>
        </div>
        <div class="days-p-content">
          <p>
            Você tem aproveitado ao máximo sua experiência na plataforma.
            Estamos felizes em tê-lo conosco por esse tempo!
          </p>
        </div>
        <div class="days-info-content">
          <div class="days-info-card-1">
            <img src="./assets/index/relogio.png" alt="" />
            <h2>Seu tempo na plataforma</h2>
            <p>
              Não se preocupe se tem muito ou pouco tempo, com a nossa
              plataforma todo dia uma nova jornada se inicia!
            </p>
            <img
              src="./assets/index/comparecimento.png"
              alt=""
              style="margin-top: 80px"
            />
            <h2>Agradecemos sua presença</h2>
            <p>Sua confiança é fundamental para nós!</p>
          </div>
          <div class="days-info-card-2" id="videoContainer"></div>
          <div class="days-info-card-1">
            <img src="./assets/index/explorar.png" alt="" />
            <h2>Vamos explorar mais sobre suas experiências na plataforma!</h2>
            <p>A cada viagem, você faz parte da nossa história de sucesso.</p>
            <img
              src="./assets/index/maos.png"
              alt=""
              style="margin-top: 80px"
            />
            <h2>Vamos em frente!</h2>
            <p>Juntos, podemos alcançar novos destinos!</p>
          </div>
        </div>
      </div>
      <div class="rating-content">
        <div class="rating-title">
          <h1>
            Desde o seu início na plataforma você vem acumulando estrelas, que
            resultou em:
          </h1>
        </div>
        <div class="rating-value">
          <img src="./assets/index/estrela.png" alt="" />
          <h1>
            <span class="rating-value-color" id="ratings">[ratings]</span>
            de avaliações na plataforma <br />;)
          </h1>
          <br />
          <p>Caprichou!</p>
        </div>
      </div>
      <div class="footer-content">
        <div class="footer-title-content">
          <p>Incrível</p>
          <h1>Você com certeza manda muito bem nas estradas!</h1>
          <p>
            Parabéns por todas as suas conquistas em 2024! Você fez a diferença
            na nossa comunidade.
          </p>
        </div>
        <div class="footer-info-content">
          <div class="rides-info-card-content">
            <img src="./assets/index/desempenho.png" alt="" />
            <h2>Seu desempenho foi admirável este ano!</h2>
          </div>
          <div class="rides-info-card-content">
            <img src="./assets/index/aperto-de-mao.png" alt="" />
            <h2>Agradecemos por fazer parte da nossa jornada!</h2>
          </div>
          <div class="rides-info-card-content">
            <img src="./assets/index/lancamento-de-foguete-fofo.png" alt="" />
            <h2>Continue acelerando rumo ao sucesso em 2025!</h2>
          </div>
        </div>
        <div class="footer-btn-content">
          <button
            class="btn"
            id="shareButton"
            onclick="generateMultipleStories()"
          >
            Compartilhe nas suas redes sociais >
          </button>
        </div>
      </div>
    </div>

    <div id="popup" class="popup">
      <div class="popup-content">
        <h2>Imagens geradas com sucesso!</h2>
        <p>Compartilhe nas suas redes sociais e inspire outras pessoas!</p>
        <button onclick="closePopup()">Fechar</button>
      </div>
    </div>
    <div id="popup-overlay" class="popup-overlay" onclick="closePopup()"></div>

    <div id="popupLoading" class="popup">
      <div class="popup-content">
        <h2>Sua retrospectiva está quase pronta!</h2>
        <p>
          Estamos reunindo os melhores momentos do seu ano. Isso pode levar
          alguns instantes, mas valerá a pena!
        </p>
        <button onclick="closePopupLoading()">Cancelar</button>
      </div>
    </div>
    <div
      id="popup-overlayLoading"
      class="popup-overlay"
      onclick="closePopupLoading()"
    ></div>

    <script>
      const root = document.documentElement;
      const username = "Pedro";
      const totalRides = "50";
      const totalKm = "1.200";
      const paymentMethod = "cartão de crédito";
      const firstDestination =
        "Av. Tancredo Neves, 148 - Caminho das Árvores, Salvador - BA, 41820-020";
      const totalDay = "1.350";
      const ratings = "4,9";
      const base64ImagesArray = [];

      document.getElementById("username-display").textContent = username;
      document.getElementById("username-display2").textContent = username;
      document.getElementById("total-rides").textContent = totalRides;
      document.getElementById("total-km").textContent = totalKm;
      document.getElementById("payment-method").textContent = paymentMethod;
      document.getElementById("first-destination").textContent =
        firstDestination;
      document.getElementById("total-days").textContent = totalDay;
      document.getElementById("ratings").textContent = ratings;

      function changePrimaryColor(newColor) {
        const root = document.documentElement;
        root.style.setProperty("--primary-color", newColor);
      }

      function getQueryParam(param) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(param);
      }

      const primaryColorFromUrl = getQueryParam("primaryColor") || "#0073f4";
      if (primaryColorFromUrl) {
        changePrimaryColor(primaryColorFromUrl);
      }

      function loadYouTubeVideo(videoId) {
        return new Promise((resolve, reject) => {
          const container = document.getElementById("videoContainer");
          container.innerHTML = "";

          const iframe = document.createElement("iframe");
          iframe.width = 560;
          iframe.height = 315;
          iframe.src = `https://www.youtube.com/embed/${videoId}`;
          iframe.title = "YouTube video player";
          iframe.frameBorder = 0;
          iframe.allow =
            "accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture";
          iframe.allowFullscreen = true;

          iframe.onload = () => resolve();
          iframe.onerror = (error) => reject(error);

          container.appendChild(iframe);
        });
      }

      function fetchVideoURL() {
        return new Promise((resolve) => {
          setTimeout(() => {
            // Substitua pelo ID do vídeo no YouTube
            const videoId = "37rV1ZbM6zg";
            resolve(videoId);
          }, 1000);
        });
      }

      function loadSVG() {
        const container = document.getElementById("videoContainer");
        container.innerHTML = "";

        fetch("./assets/index/10594481_4482349.svg")
          .then((response) => {
            if (!response.ok) {
              throw new Error("Erro ao carregar o SVG");
            }
            return response.text();
          })
          .then((svgData) => {
            container.innerHTML = svgData;
            container.style.display = "block";

            const svgElement = container.querySelector("svg");

            svgElement
              .querySelectorAll('[style*="fill"]')
              .forEach((element) => {
                if (element.style.fill === "red") {
                  element.style.fill = primaryColorFromUrl;
                }
              });
          })
          .catch((error) => console.error("Erro ao carregar o SVG:", error))
          .finally(() => {
            // generateMultipleStories();
          });
      }

      fetchVideoURL()
        .then((videoId) => {
          if (videoId) {
            loadYouTubeVideo(videoId);
          } else {
            throw new Error("Vídeo não encontrado");
          }
        })
        .catch((error) => {
          console.error(
            "Erro ao carregar o vídeo, carregando SVG como fallback:",
            error
          );
          loadSVG();
        })
        .finally(() => {
          //   generateMultipleStories();
        });

      function showPopup() {
        document.getElementById("popup").classList.add("show");
        document.getElementById("popup-overlay").classList.add("show");
      }

      function closePopup() {
        document.getElementById("popup").classList.remove("show");
        document.getElementById("popup-overlay").classList.remove("show");
      }

      function showPopupLoading() {
        document.getElementById("popupLoading").classList.add("show");
        document.getElementById("popup-overlayLoading").classList.add("show");
      }

      function closePopupLoading() {
        document.getElementById("popupLoading").classList.remove("show");
        document
          .getElementById("popup-overlayLoading")
          .classList.remove("show");
      }

      function addLogo(wrapper) {
        const logoContainer = wrapper.querySelector("#logoContainer");
        if (logoContainer) {
          const logoImg = document.createElement("img");
          logoImg.src = "assets/story1/logoStories.png";
          logoImg.alt = "logo";
          logoImg.width = 206;
          logoImg.height = 68;

          logoContainer.appendChild(logoImg);
        }
      }

      function generateSharingImage(storyId) {
        return new Promise((resolve, reject) => {
          const htmlPath = `${storyId}.html`;
          const svgPath = `assets/${storyId}/imgStory${storyId.replace(
            "story",
            ""
          )}.svg`;
          const downloadName = `${storyId}-image.png`;

          fetch(htmlPath)
            .then(async (response) => {
              if (!response.ok) {
                throw new Error(
                  `Erro ao carregar ${htmlPath}: ${response.statusText}`
                );
              }
              return await response.text();
            })
            .then((html) => {
              const container = document.createElement("div");
              container.style.position = "absolute";
              container.style.top = "-9999px";
              container.style.left = "-9999px";
              container.style.width = "1080px";
              container.style.height = "1920px";
              container.style.overflow = "hidden";
              container.style.zIndex = "-1";
              document.body.appendChild(container);

              const shadowRoot = container.attachShadow({ mode: "open" });

              const wrapper = document.createElement("div");
              wrapper.innerHTML = html;
              shadowRoot.appendChild(wrapper);

              const stylesheets = Array.from(
                document.querySelectorAll("link[rel='stylesheet']")
              );
              stylesheets.forEach((stylesheet) => {
                const link = document.createElement("link");
                link.rel = "stylesheet";
                link.href = stylesheet.href;
                shadowRoot.appendChild(link);
              });

              wrapper.style.setProperty("--primary-color", primaryColorFromUrl);

              addLogo(wrapper);

              const svgContainer = wrapper.querySelector("#svgContainer");
              const carregarSVG = () => {
                return new Promise((resolveSVG, rejectSVG) => {
                  if (svgContainer) {
                    fetch(svgPath)
                      .then((response) => {
                        if (!response.ok) {
                          throw new Error(`Erro ao carregar o SVG: ${svgPath}`);
                        }
                        return response.text();
                      })
                      .then((svgData) => {
                        svgContainer.innerHTML = svgData;

                        const svgElement = svgContainer.querySelector("svg");

                        if (svgElement) {
                          svgElement
                            .querySelectorAll("[fill]")
                            .forEach((element) => {
                              const currentFill = element.getAttribute("fill");
                              if (
                                currentFill === "#0073F4" ||
                                currentFill === "red"
                              ) {
                                element.setAttribute(
                                  "fill",
                                  primaryColorFromUrl
                                );
                              }
                            });

                          svgElement
                            .querySelectorAll("[style]")
                            .forEach((element) => {
                              const style = element.getAttribute("style");
                              if (style && style.includes("fill:")) {
                                element.setAttribute(
                                  "style",
                                  style.replace(
                                    /fill: ?[^;]+;/,
                                    `fill: ${primaryColorFromUrl};`
                                  )
                                );
                              }
                            });
                        }
                        resolveSVG();
                      })
                      .catch((error) => {
                        console.error(
                          `Erro ao carregar e modificar o SVG (${svgPath}):`,
                          error
                        );
                        rejectSVG(error);
                      });
                  } else {
                    resolveSVG();
                  }
                });
              };

              // Carregar o SVG e depois gerar a imagem
              carregarSVG()
                .then(() => {
                  // Alterar cor de fundo do conteúdo
                  const conteudoCompartilhamento = wrapper.querySelector(
                    "#conteudo-compartilhamento"
                  );
                  if (conteudoCompartilhamento) {
                    conteudoCompartilhamento.style.backgroundColor =
                      primaryColorFromUrl;
                  }

                  // Definir dados fictícios (se necessário)
                  const storiesData = {
                    totalRidesStories: "824",
                    totalKmStories: "5462",
                    totalRatingStories: "4,7",
                    totalDaysStories: "276",
                    paymentMethodStories: "Cartão",
                    firstDestinationStories:
                      "Av. Tancredo Neves, 148 - Caminho das Árvores, Salvador - BA, 41820-020.",
                  };

                  Object.entries(storiesData).forEach(([id, value]) => {
                    const element = wrapper.querySelector(`#${id}`);
                    if (element) {
                      element.innerText = value;
                    }
                  });

                  setTimeout(() => {
                    domtoimage
                      .toPng(wrapper)
                      .then((dataUrl) => {
                        const canvas = document.createElement("canvas");
                        const img = new Image();
                        img.src = dataUrl;

                        img.onload = () => {
                          canvas.width = img.width;
                          canvas.height = img.height;
                          const ctx = canvas.getContext("2d");
                          ctx.drawImage(img, 0, 0);
                          document.body.removeChild(container);

                          resolve({
                            id: storyId,
                            image: getBase64FromCanvas(canvas),
                          });
                        };
                        img.onerror = (error) => {
                          console.error(
                            "Erro ao carregar imagem para conversão:",
                            error
                          );
                          document.body.removeChild(container);
                          reject(error);
                        };
                      })
                      .catch((error) => {
                        document.body.removeChild(container);
                        reject(`Erro ao gerar a imagem: ${error}`);
                      });
                  }, 1000);
                })
                .catch((error) => {
                  console.error(
                    `Erro ao carregar o conteúdo da imagem ${storyId}.`,
                    error
                  );
                  document.body.removeChild(container);
                  reject(error);
                });
            })
            .catch((error) => {
              console.error(`Erro ao carregar o HTML: ${htmlPath}.`, error);
              document.body.removeChild(container);
              reject(error);
            });
        });
      }

      function getBase64FromCanvas(canvas) {
        const dataURL = canvas.toDataURL("image/png");
        const base64 = dataURL.split(",")[1];
        return base64;
      }

      function generateMultipleStories() {
        const button = document.getElementById("shareButton");
        button.classList.add("loading");
        const stories = [
          "story1",
          "story2",
          "story3",
          "story4",
          "story5",
          "story6",
        ];

        Promise.all(stories.map((story) => generateSharingImage(story)))
          .then((images) => {
            try {
              images.forEach(({ id, image }) => {
                base64ImagesArray.push(image);
              });
              sendBase64ToApp();
            } catch (error) {
              console.error("Erro no processamento das imagens:", error);
              throw error;
            }
          })
          .catch((error) => {
            console.error(`Erro ao gerar imagens: ${error.message}`);
          })
          .finally(() => {
            button.classList.remove("loading");
          });
      }

      function sendBase64ToApp() {
        if (base64ImagesArray.length > 0) {
          var vars = {};
          var parts = window.location.href.replace(
            /[?&]+([^=&]+)=([^&]*)/gi,
            function (m, key, value) {
              vars[key] = value;
            }
          );
          const base64ImageJSON = JSON.stringify(base64ImagesArray);

          switch (vars["device"]) {
            case "flutter":
              window.flutter.postMessage({
                action: "onResult",
                data: base64ImageJSON,
              });
              break;

            case "android":
              window.Android.onResult(base64ImageJSON);
              break;

            default:
              console.log(base64ImagesArray);
              break;
          }

          showPopup();
        }
      }
    </script>
  </body>
</html>
